{% extends 'resort/base.html' %}

{% block title %}{{ room_category.name }} - Vivaan Farmhouse{% endblock %}
{% csrf_token %}
{% load static %}
{% block content %}


<style>
    /* üî¥ Booked dates */
    .flatpickr-day.booked-date {
        background: #f57e7eff !important;
        /* red-500 */   
        color: white !important;
        border: 1px solid #fb8282ff !important;
        cursor: not-allowed;
    }

    /* üü† Admin blocked dates */
    .flatpickr-day.blocked-date {
        background: rgba(233, 146, 84, 1) !important;
        /* orange-500 */
        color: white !important;
        border: 1px solid #f8a970ff !important;
        cursor: not-allowed;
    }

    /* üü¢ Selected range */
    .flatpickr-day.inRange,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange {
        background: #c9f5d9ff !important;
        /* green-500 */
        color: white !important;
        border: 1px solid #b7fbcfff !important;
    }

    /* üîµ Today */
    .flatpickr-day.today {
        border-color: #011637ff !important;
        /* blue-500 */
    }

    /* Disabled look */
    .flatpickr-day.disabled {
        opacity: 0.6;
    }
</style>


<style>
.collapse-header {
    cursor: pointer;
    padding: 16px;
    background: white; /* emerald-900 */
    color: #043c2a;
    font-weight: 600;
    border-radius: 12px;
    border: 2px solid #012a1d;
}
</style>
<style>
.collapse-header {
    pointer-events: none;
}


.time-dropdown {
    position: relative;
}

.time-btn {
    width: 100%;
    height: 46px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 0 10px;
    background: white;
    text-align: left;
    font-size: 15px;
      font-weight: 500;

    cursor: pointer;
    color: #0c0c0ccb; 
}

.time-list {
    position: absolute;
    width: 100%;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: white;
    margin-top: 4px;
    z-index: 50;
}

/* üî• EXACT 30px OPTION HEIGHT */
.time-option {
    height: 30px;
    line-height: 30px;
    padding: 0 10px;
    cursor: pointer;
    font-size: 14px;
}

.time-option:hover {
    background-color: #047857;
    color: white;
}

/* Scrollbar */
.time-list::-webkit-scrollbar {
    width: 6px;
}
.time-list::-webkit-scrollbar-thumb {
    background: #047857;
    border-radius: 4px;
}
</style>

<div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('{% static " images/vihan-group1.webp"
        %}');">
    </div>
    <div class="absolute inset-0 bg-white/90"></div>
</div>

<!-- Room Header -->
{% comment %} <section class="relative h-96 flex items-center justify-center text-white overflow-hidden">
    <div class="absolute inset-0 z-0">
        <div class="absolute inset-0 bg-gradient-to-r from-black/60 to-black/40 z-10"></div>
        {% if room_category.image %}
        <div class="absolute inset-0 bg-cover bg-center"
            style="background-image: url('{{ room_category.image.url }}');"></div>
        {% else %}
        <div class="absolute inset-0 bg-gradient-to-br from-red-600 to-red-800"></div>
        {% endif %}
    </div>

    <div class="container mx-auto px-4 z-20">
        <h1 class="text-4xl md:text-6xl font-bold mb-4">{{ room_category.name }}</h1>
        <div class="flex flex-wrap gap-4 text-lg">
            <span><i class="fas fa-ruler-combined mr-2"></i>{{ room_category.size_sqft }} sq ft</span>
            <span><i class="fas fa-users mr-2"></i>Up to {{ room_category.max_occupancy }} Guests</span>
            <span><i class="fas fa-building mr-2"></i>{{ room_category.floor }}</span>
        </div>
    </div>
</section> {% endcomment %}

<!-- Room Details & Booking -->


<section class=" py-4 md:py-16 ">
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Booking Form -->
            <div class="">
                <div class="bg-white rounded-2xl shadow-xl p-2  md:p-8 sticky top-32">
                    <div class="text-center mb-6">
                        <div class="space-y-2">
                            <div class="text-2xl font-bold text-gray-800">Entire Villa Booking</div>
                            <div class="flex justify-between text-sm text-gray-600 border-b pb-2">
                                <span>Monday-Friday (Week days)</span>
                                <span class="font-bold text-emerald-600">‚Çπ{{ pricing.weekday_price }}</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Saturday-Sunday (Weekends)</span>
                                <span class="font-bold text-emerald-600">‚Çπ{{ pricing.weekend_price }}</span>
                            </div>
                        </div>
                    </div>


                    <form method="post" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" id="discountedTotal" value="{{ calculated_total }}">






                        {% if form.errors %}
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                            {% endfor %}
                        </div>
                        {% endif %}


<!-- =========================== -->
<div class="border rounded-xl">
    <div class="collapse-header" onclick="toggleCollapse('step1')">
        1. Stay Details & Dates
    </div>

         <div  id="step1" class="collapse-body  p-6 space-y-4">



                        <div class="flex flex-wrap gap-4 text-sm mt-3">
                            <div class="flex items-center gap-2">
                                <span class="w-4 h-4 bg-green-300 rounded"></span> Selected
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-4 h-4 bg-[#f57e7eff] rounded"></span> Booked
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-4 h-4 bg-[#f8a970ff] rounded"></span> Blocked by Admin
                            </div>
                        </div>

                        <div class="grid  grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Check-in Date</label>
                                <input type="text" name="check_in"      readonly
    inputmode="none"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                    placeholder="Select Date" required>
                            </div>

   <div>
                                <label class="block text-gray-700 font-semibold mb-2">Check-out Date</label>
                                <input type="text" name="check_out"      readonly
    inputmode="none"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                    placeholder="Select Date" required>
                            </div>


                            <!-- <div>
                                <label class="block text-gray-700 font-semibold mb-2">Time</label>
                                <input type="text" name="check_in_time"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                    placeholder="Select Time">
                            </div> -->
                        </div>


                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<!-- Check-in Time -->
{% comment %} <div>
    <label class="block text-gray-700 font-semibold mb-2">Check-In Time</label>

    <input type="hidden" name="check_in_time" id="checkInTime">

    <div class="time-dropdown">
        <button type="button" class="time-btn" onclick="toggleTime('in')">
            Select Check-In Time
        </button>

        <div id="timeListIn" class="time-list hidden"></div>
    </div>
</div> {% endcomment %}

<!-- Check-out Time -->
{% comment %} <div>
    <label class="block text-gray-700 font-semibold mb-2">Check-Out Time</label>

    <input type="hidden" name="check_out_time" id="checkOutTime">

    <div class="time-dropdown">
        <button type="button" class="time-btn" onclick="toggleTime('out')">
            Select Check-Out Time
        </button>

        <div id="timeListOut" class="time-list hidden"></div>
    </div>
</div> {% endcomment %}

<!-- CHECK-IN TIME -->
<div>
    <label class="block text-gray-700 font-semibold mb-2">Check-In Time</label>

    <input type="hidden" name="check_in_time" id="checkInTime">

    <div class="time-dropdown">
        <button type="button" class="time-btn" onclick="toggleTime('in')">
            Select Check-In Time
        </button>
        <div id="timeListIn" class="time-list hidden"></div>
    </div>
</div>

<!-- CHECK-OUT TIME -->
<div>
    <label class="block text-gray-700 font-semibold mb-2">Check-Out Time</label>

    <input type="hidden" name="check_out_time" id="checkOutTime">

    <div class="time-dropdown">
        <button type="button" class="time-btn" onclick="toggleTime('out')">
            Select Check-Out Time
        </button>
        <div id="timeListOut" class="time-list hidden"></div>
    </div>
</div>

<!-- <div>
                                <label class="block text-gray-700 font-semibold mb-2">Check-In Time</label>
                                <input type="text" name="check_in_time"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                    placeholder="Select Check In Time">
                            </div>



                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Check-Out Time</label>
                                <input type="text" name="check_out_time"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                    placeholder="Select Check Out Time">
                            </div> -->
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" >

                                   <div>
                                <label class="block text-gray-700 font-semibold mb-2">Number of Guests</label>
                                {{ form.guest_count }}
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Number of Extra Guests
                                    Count</label>
                                {{ form.extra_guest_count }}
                            </div>

                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Special Requests</label>
                            {{ form.special_requests }}
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Coupon Code</label>
                            {{ form.coupon_code }}
                        </div>



                        <div id="dateNotification"
                            class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span id="dateNotificationText"></span>
                            </div>
                        </div>






                         <div class="flex justify-end pt-4">
    <button type="button"
        onclick="validateStep1()"
        class="bg-emerald-900 text-white px-6 py-2 rounded-lg font-semibold">
        Next ‚Üí
    </button>
</div>



 </div>



 </div>
<!-- ======================================== -->



                        <!-- ============================= -->

                        
<div class="border rounded-xl">
    <div class="collapse-header" onclick="toggleCollapse('step2')">
        2. Guest Information
    </div>


    <div id="step2" class="collapse-body hidden p-6 space-y-4">
                        <div  >
                            <label class="block text-gray-700 font-semibold mb-2">Full Name</label>
                            {{ form.guest_name }}
                        </div>
                        <!-- <div class="grid grid-cols-2 gap-4"> -->
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Phone</label>
                                {{ form.guest_phone }}
                            </div>

                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                                {{ form.guest_email }}
                            </div>
                        <!-- </div> -->





                        <div class="flex justify-between pt-4">
    <button type="button"
        onclick="toggleCollapse('step1')"
        class="border border-emerald-900 text-emerald-900 px-6 py-2 rounded-lg">
        ‚Üê Previous
    </button>

    <button type="button"
        onclick="validateStep2()"
        class="bg-emerald-900 text-white px-6 py-2 rounded-lg font-semibold">
        Next ‚Üí
    </button>
</div>
</div>





</div>
<!-- ========================================= -->


<!-- ========================== -->


<div class="border rounded-xl">
    <div class="collapse-header" onclick="toggleCollapse('step3')">
        3Ô∏è. Payment Method & Summary
    </div>

  <div  id="step3" class="collapse-body hidden p-6 space-y-4">

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Payment Method</label>

                            <div class="space-y-3">


                                <label
                                    class="flex items-center space-x-3 border p-3 rounded-lg cursor-pointer hover:border-emerald-600">
                                    <input type="radio" name="payment_method" value="farmhouse"
                                        class="h-5 w-5 text-emerald-600" checked>
                                    <span class="text-gray-800 font-medium">Pay at Check-in (Cash)</span>
                                </label>


                                <label
                                    class="flex items-center space-x-3 border p-3 rounded-lg cursor-pointer hover:border-emerald-600">
                                    <input type="radio" name="payment_method" value="partial_razorpay"
                                        class="h-5 w-5 text-emerald-600">
                                    <span class="text-gray-800 font-medium">Pay 30% Online (Razorpay)</span>
                                </label>


                                <label
                                    class="flex items-center space-x-3 border p-3 rounded-lg cursor-pointer hover:border-emerald-600">
                                    <input type="radio" name="payment_method" value="full_razorpay"
                                        class="h-5 w-5 text-emerald-600">
                                    <span class="text-gray-800 font-medium">Pay Full Online (Razorpay)</span>
                                </label>

                            </div>
                        </div>


                        <div id="paymentSummary" class="hidden mt-5 space-y-3">

                            <div class="border rounded-lg p-4 bg-gray-50">

                                <p id="depositAmount" class="hidden flex justify-between text-gray-700 text-lg">
                                    <span>Pay now (30%):</span>
                                    <span class="font-bold text-emerald-700">‚Çπ<span id="depositValue"></span></span>
                                </p>

                                <p id="fullAmount" class="hidden flex justify-between text-gray-700 text-lg">
                                    <span>Pay full:</span>
                                    <span class="font-bold text-emerald-700">‚Çπ<span id="fullValue"></span></span>
                                </p>

                                <p id="remainingAmount" class="hidden text-sm text-gray-600">
                                    Remaining at check-in:
                                    <span class="font-semibold text-gray-800">‚Çπ<span id="remainingValue"></span></span>
                                </p>

                            </div>


                            <div id="razorpayBox" class="hidden border p-4 rounded-xl space-y-2">
                                <p class="font-semibold text-gray-700">Select Razorpay to complete payment</p>
                                <div class="flex items-center space-x-3">
                                    <input type="radio" checked class="h-5 w-5">
                                    <img src="https://razorpay.com/favicon.png" class="h-6" />
                                    <span class="font-medium text-gray-700">Razorpay Checkout</span>
                                </div>
                            </div>

                        </div>
                 
<div class="flex justify-start pt-2">
    <button type="button"
        onclick="toggleCollapse('step2')"
        class="border border-emerald-900 text-emerald-900 px-6 py-2 rounded-lg">
        ‚Üê Previous
    </button>
</div>



</div>


</div>

                        <button type="submit"
                            class="w-full bg-emerald-900 text-white py-4 rounded-lg font-bold text-lg transition duration-300 hover:bg-emerald-700">
                            <i class="fas fa-calendar-check mr-2"></i>Book Entire Villa
                        </button>


                    </form>

                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="flex items-start text-sm text-gray-600">
                            <i class="fas fa-info-circle text-red-600 mr-2 mt-1"></i>
                            <p>Free cancellation up to 24 hours before check-in</p>
                        </div>
                        {% if booked_dates %}
                        <div class="mt-4 bg-amber-50 border border-amber-300 rounded-lg p-3">
                            <p class="text-xs text-amber-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                <strong>{{ booked_dates|length }} dates</strong> are currently booked. Please avoid
                                selecting these dates.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>






            <!-- Room Information -->
            <div class="">

                <!-- Amenities -->
                <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Room Amenities</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-wifi text-emerald-700  mr-3"></i>
                            <span>Free WiFi</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-tv text-emerald-700 mr-3"></i>
                            <span>Smart TV</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-snowflake text-emerald-700 mr-3"></i>
                            <span>Air Conditioning</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-coffee text-emerald-700 mr-3"></i>
                            <span>Mini Bar</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-concierge-bell text-emerald-700 mr-3"></i>
                            <span>24/7 Room Service</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-lock text-emerald-700 mr-3"></i>
                            <span>Safe Locker</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-shower text-emerald-700 mr-3"></i>
                            <span>Hot Water</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-phone text-emerald-700 mr-3"></i>
                            <span>Telephone</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-wind text-emerald-700 mr-3"></i>
                            <span>Room Heater</span>
                        </div>
                    </div>
                </div>


                <!-- Description -->
                <div class=" rounded-2xl shadow-lg p-8  bg-white">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Room Description</h2>
                    <p class="text-gray-600 text-lg leading-relaxed mb-6">{{ room_category.description|safe }}</p>
                    {% comment %} <div class="rounded-2xl shadow-lg p-8 bg-white">
                        {{ room_category.description|safe }}
                    </div> {% endcomment %}
                </div>


            </div>









        </div>
    </div>
</section>

{% block extra_js %}
{% comment %} {{ booked_dates|json_script:"booked-dates-data" }} {% endcomment %}
{{ booked_dates|json_script:"booked-dates-data" }}
{{ booked_info|json_script:"booked-info-data" }}
{{ blocked_dates|json_script:"blocked-dates-data" }}

{% comment %}
<script id="blocked-dates-data" type="application/json">
    {{ blocked_dates|json_script:"blocked-dates-data" }}
</script> {% endcomment %}






<script>
function toggleCollapse(id) {
    document.querySelectorAll('.collapse-body').forEach(el => {
        if (el.id === id) {
            el.classList.toggle('hidden');
        } else {
            el.classList.add('hidden');
        }
    });
}
</script>



 <script>
const startHour = 7;   // 7 AM
const endHour = 22;    // 10 PM

function generateSlots() {
    const slots = [];
    for (let h = startHour; h < endHour; h++) {
        slots.push(formatHour(h));
    }
    return slots;
}

function formatHour(h) {
    const suffix = h >= 12 ? "PM" : "AM";
    const hour = h % 12 || 12;
    return `${hour}:00 ${suffix}`;
}

function buildDropdown(listId, inputId, button) {
    const list = document.getElementById(listId);
    list.innerHTML = "";

    generateSlots().forEach(label => {
        const div = document.createElement("div");
        div.className = "time-option";
        div.innerText = label;

        div.onclick = () => {
            // Convert 12h ‚Üí 24h (DB format)
            let hour = parseInt(label);
            const isPM = label.includes("PM");

            if (isPM && hour !== 12) hour += 12;
            if (!isPM && hour === 12) hour = 0;

            // ‚úÖ Save to hidden input
            document.getElementById(inputId).value =
                String(hour).padStart(2, "0") + ":00";

            // ‚úÖ Show selected time
            button.innerText = label;

            list.classList.add("hidden");
        };

        list.appendChild(div);
    });
}

function toggleTime(type) {
    const list = document.getElementById(
        type === "in" ? "timeListIn" : "timeListOut"
    );
    const btn = list.previousElementSibling;
    const inputId = type === "in" ? "checkInTime" : "checkOutTime";

    buildDropdown(list.id, inputId, btn);
    list.classList.toggle("hidden");
}

// Close dropdown on outside click
document.addEventListener("click", e => {
    if (!e.target.closest(".time-dropdown")) {
        document.querySelectorAll(".time-list")
            .forEach(l => l.classList.add("hidden"));
    }
});
</script>


<script>
/* =========================
   STEP-1 VALIDATION
   ========================= */
function validateStep1() {
    const checkInDate = document.querySelector("input[name='check_in']").value;
    const checkOutDate = document.querySelector("input[name='check_out']").value;
    const checkInTime = document.querySelector("#checkInTime").value;
    const checkOutTime = document.querySelector("#checkOutTime").value;

    if (!checkInDate) {
        alert("Please select check-in date");
        return;
    }

    if (!checkOutDate) {
        alert("Please select check-out date");
        return;
    }

    if (!checkInTime) {
        alert("Please select check-in time");
        return;
    }

    if (!checkOutTime) {
        alert("Please select check-out time");
        return;
    }

    // ‚úÖ SAME-DAY TIME VALIDATION
    if (checkInDate === checkOutDate) {
        const inHour = parseInt(checkInTime.split(":")[0]);
        const outHour = parseInt(checkOutTime.split(":")[0]);

        if (outHour <= inHour) {
            alert("Check-out time must be after check-in time");
            return;
        }
    }

    // ‚úÖ MOVE TO STEP-2
    toggleCollapse("step2");
}

/* =========================
   STEP-2 VALIDATION
   ========================= */
function validateStep2() {
    const name = document.querySelector("input[name='guest_name']").value.trim();
    const phone = document.querySelector("input[name='guest_phone']").value.trim();
    const email = document.querySelector("input[name='guest_email']").value.trim();

    if (!name) {
        alert("Please enter full name");
        return;
    }

    if (!phone || phone.length < 10) {
        alert("Please enter valid phone number");
        return;
    }

    if (!email || !email.includes("@")) {
        alert("Please enter valid email address");
        return;
    }

    // ‚úÖ STEP-2 COMPLETED ‚Üí OPEN STEP-3
    toggleCollapse("step3");
}

/* =========================
   INITIAL STATE
   ========================= */
document.addEventListener("DOMContentLoaded", function () {
    toggleCollapse("step1"); // open only step-1 on load
});
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ‚úÖ DECLARE ONCE (FIX)
        let couponDiscount = 0;
        let couponTimer = null;
        // Form inputs
        let checkIn = document.querySelector("input[name='check_in']");
        let checkOut = document.querySelector("input[name='check_out']");
        let guestCount = document.querySelector("input[name='guest_count']");
        let extraGuest = document.querySelector("input[name='extra_guest_count']");
        let radios = document.querySelectorAll("input[name='payment_method']");

        let couponInput = document.querySelector("input[name='coupon_code']");


        // Payment display elements
        const paymentSummary = document.getElementById("paymentSummary");
        const depositAmount = document.getElementById("depositAmount");
        const fullAmount = document.getElementById("fullAmount");
        const remainingAmount = document.getElementById("remainingAmount");
        const razorpayBox = document.getElementById("razorpayBox");

        // Backend pricing values
        const weekday = parseFloat(`{{ pricing.weekday_price }}`);
        const weekend = parseFloat(`{{ pricing.weekend_price }}`);
        const extraGuestPrice = parseFloat(`{{ extra_price }}`);

        // Calculate Base Amount
        function calculateTotal() {
            const inDate = new Date(checkIn.value);
            const outDate = new Date(checkOut.value);

            if (!checkIn.value || !checkOut.value || outDate <= inDate) {
                return 0;
            }

            let total = 0;
            let date = new Date(inDate);

            // Loop through each night
            while (date < outDate) {
                let day = date.getDay();
                if (day === 5 || day === 6) {
                    total += weekend;
                } else {
                    total += weekday;
                }
                date.setDate(date.getDate() + 1);
            }

            // EXTRA GUEST COUNT logic (user entered)
            let extra = parseInt(extraGuest.value || 0);

            total += extra * extraGuestPrice;

            // NO TAX (you set 0.00)
            total += total * 0.00;

            return Math.round(total);
        }

        // Update Payment Method Section
        function updatePayment() {
            let total = calculateTotal();


            // apply coupon discount LIVE
            if (couponDiscount > 0) {
                total = total - couponDiscount;
                if (total < 0) total = 0;
            }


            if (total <= 0) {
                paymentSummary.classList.add("hidden");
                return;
            }

            paymentSummary.classList.remove("hidden");

            // Calculate 30%
            let deposit = Math.round(total * 0.30);
            let remaining = total - deposit;

            document.getElementById("depositValue").innerText = deposit;
            document.getElementById("fullValue").innerText = total;
            document.getElementById("remainingValue").innerText = remaining;

            let selected = document.querySelector("input[name='payment_method']:checked").value;

            if (selected === "farmhouse") {
                depositAmount.classList.add("hidden");
                fullAmount.classList.remove("hidden");
                remainingAmount.classList.add("hidden");
                razorpayBox.classList.add("hidden");
            }

            if (selected === "partial_razorpay") {
                depositAmount.classList.remove("hidden");
                remainingAmount.classList.remove("hidden");
                fullAmount.classList.add("hidden");
                razorpayBox.classList.remove("hidden");
            }

            if (selected === "full_razorpay") {
                fullAmount.classList.remove("hidden");
                depositAmount.classList.add("hidden");
                remainingAmount.classList.add("hidden");
                razorpayBox.classList.remove("hidden");
            }
        }

        /**************************************
            LIVE COUPON VALIDATION (AJAX)
           **************************************/
        couponInput.addEventListener("change", function () {

            let code = couponInput.value.trim();

            if (code === "") {
                couponDiscount = 0;
                updatePayment();
                return;
            }

            fetch(`/validate-coupon/?code=${code}`)
                .then(res => res.json())
                .then(data => {
                    if (data.valid) {
                        couponDiscount = parseFloat(data.discount);
                        alert(`Coupon Applied! Discount: ‚Çπ${couponDiscount}`);
                    } else {
                        couponDiscount = 0;
                        alert("Invalid coupon code!");
                    }
                    updatePayment();
                })
                .catch(() => {
                    couponDiscount = 0;
                    updatePayment();
                });
        });



        // ===============================
        // DEBOUNCED COUPON CHECK
        // ===============================









        // ===============================
        // DEBOUNCED COUPON CHECK
        // ===============================

        // Attach event listeners
        radios.forEach(r => r.addEventListener("change", updatePayment));
        checkIn.addEventListener("change", updatePayment);
        checkOut.addEventListener("change", updatePayment);
        guestCount.addEventListener("input", updatePayment);
        extraGuest.addEventListener("input", updatePayment);

        // moved validation here
        guestCount.addEventListener("input", function () {
            if (parseInt(this.value) > 15) {
                alert("Guest count cannot exceed 15.");
                this.value = 15;
            }
        });

        extraGuest.addEventListener("input", function () {
            if (parseInt(this.value) > 5) {
                alert("Extra guest count cannot exceed 5.");
                this.value = 5;
            }
        });

        updatePayment();

    });

</script>



{% comment %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script> {% endcomment %}
<script>
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
</script>

<script>
    document.querySelector("form").addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch("", {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "X-Requested-With": "XMLHttpRequest"
            },
            body: formData
        })
            .then(res => res.json())
            .then(data => {

                if (data.redirect) {
                    window.location.href = data.url;
                    return;
                }

                if (data.razorpay) {
                    openRazorpay(data.amount);
                }
            });
    });


    function openRazorpay(amount) {

        fetch("/create-razorpay-order/", {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `amount=${amount}`
        })
            .then(res => res.json())
            .then(data => {

                const options = {
                    key: data.key,
                    amount: data.amount,
                    currency: "INR",
                    name: "Vivaan Farmhouse",
                    order_id: data.order_id,

                    handler: function (response) {

                        // ‚ùå If payment cancelled
                        if (!response.razorpay_payment_id) {
                            alert("Payment cancelled or failed");
                            return;
                        }

                        // ‚úÖ STORE ORDER ID FOR POLLING
                        localStorage.setItem(
                            "rzp_order_id",
                            response.razorpay_order_id
                        );

                        // üöÄ REDIRECT IMMEDIATELY (FAST UX)
                        window.location.href = "/payment-processing/";

                        // üîÅ VERIFY IN BACKGROUND (DO NOT WAIT)
                        fetch("/verify-payment/", {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": getCSRFToken(),
                                "Content-Type": "application/x-www-form-urlencoded"
                            },
                            body:
                                `razorpay_payment_id=${response.razorpay_payment_id}` +
                                `&razorpay_order_id=${response.razorpay_order_id}` +
                                `&razorpay_signature=${response.razorpay_signature}`
                        });
                    },

                    modal: {
                        ondismiss: function () {
                            alert("Payment cancelled");
                        }
                    },

                    theme: {
                        color: "#047857"
                    }
                };

                const rzp = new Razorpay(options);
                rzp.open();
            })
            .catch(err => {
                console.error("Razorpay error:", err);
                alert("Payment initialization failed");
            });
    }


</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {

        if (typeof flatpickr === "undefined") {
            console.error("‚ùå Flatpickr not loaded");
            return;
        }

        const bookedDates = JSON.parse(
            document.getElementById("booked-dates-data")?.textContent || "[]"
        );

        const blockedDates = JSON.parse(
            document.getElementById("blocked-dates-data")?.textContent || "[]"
        );

        const disabledDates = [...new Set([...bookedDates, ...blockedDates])];

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return `${y}-${m}-${d}`;
        }

        function decorateDay(dayElem) {
            const dateStr = formatDate(dayElem.dateObj);

            if (bookedDates.includes(dateStr)) {
                dayElem.classList.add("booked-date");
                dayElem.title = "Already booked";
            }

            if (blockedDates.includes(dateStr)) {
                dayElem.classList.add("blocked-date");
                dayElem.title = "Blocked by admin";
            }

            
        }

        let checkInPicker;
        let checkOutPicker;

        // ‚úÖ CHECK-IN
        checkInPicker = flatpickr("input[name='check_in']", {
            dateFormat: "Y-m-d",
            minDate: "today",
            disable: disabledDates,
            allowInput: true,

            onDayCreate(_, __, ___, dayElem) {
                decorateDay(dayElem);
            },

            onChange(selectedDates) {
                if (!selectedDates.length) return;

                const nextDay = new Date(selectedDates[0]);
                nextDay.setDate(nextDay.getDate() + 1);

                checkOutPicker.set("minDate", nextDay);
            }
        });

        // ‚úÖ CHECK-OUT
        checkOutPicker = flatpickr("input[name='check_out']", {
            dateFormat: "Y-m-d",
            minDate: "today",
            disable: disabledDates,
            allowInput: true,

            onDayCreate(_, __, ___, dayElem) {
                decorateDay(dayElem);
            },

            onChange(selectedDates) {
                if (!selectedDates.length) return;

                const checkInDate = checkInPicker.selectedDates[0];

                if (!checkInDate) {
                    alert("‚ö†Ô∏è Please select check-in date first");
                    checkOutPicker.clear();
                    return;
                }

                let current = new Date(checkInDate);
                const end = new Date(selectedDates[0]);

                while (current <= end) {
                    const dStr = formatDate(current);

                    if (blockedDates.includes(dStr)) {
                        alert("‚ö†Ô∏è Selected range includes dates blocked by admin");
                        checkOutPicker.clear();
                        return;
                    }

                    current.setDate(current.getDate() + 1);
                }

            }
        });

        console.log("‚úÖ Flatpickr initialized correctly (SINGLE INSTANCE)");
    });
</script>












{% endblock %}
{% endblock %}





