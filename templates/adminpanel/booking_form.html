{% extends "adminpanel/base.html" %}
{% load static %}

{% block content %}

<h2>Create Booking (Admin)</h2>

<style>
.flatpickr-day.admin-booked {
    background: #ef4444 !important;
    color: white !important;
}

.flatpickr-day.admin-blocked {
    background: #f59e0b !important;
    color: white !important;
}

.flatpickr-day.flatpickr-disabled {
    opacity: 1 !important;
}
</style>

<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button class="btn btn-success">Create Booking</button>
</form>

<!-- ðŸ”‘ DATA -->
{{ booked_dates|json_script:"booked-dates" }}
{{ blocked_dates|json_script:"blocked-dates" }}

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const bookedDates = JSON.parse(
        document.getElementById("booked-dates").textContent
    );
    const blockedDates = JSON.parse(
        document.getElementById("blocked-dates").textContent
    );

    const disabledDates = [...new Set([...bookedDates, ...blockedDates])];

    function formatLocal(date) {
        return date.getFullYear() + "-" +
            String(date.getMonth() + 1).padStart(2, "0") + "-" +
            String(date.getDate()).padStart(2, "0");
    }

    function decorate(dayElem) {
        const d = formatLocal(dayElem.dateObj);

        if (bookedDates.includes(d)) {
            dayElem.classList.add("admin-booked");
            dayElem.title = "Already booked";
        }

        if (blockedDates.includes(d)) {
            dayElem.classList.add("admin-blocked");
            dayElem.title = "Blocked by admin";
        }
    }

    let checkOutPicker;

    // âœ… CHECK-IN (ONLY COLOR â€” NO DISABLE)
    const checkInPicker = flatpickr("input[name='check_in']", {
        dateFormat: "Y-m-d",
        minDate: "today",
        disableMobile: true,

        onDayCreate(_, __, ___, dayElem) {
            decorate(dayElem);
        },

        onChange(selectedDates) {
            if (!selectedDates.length) return;

            const next = new Date(selectedDates[0]);
            next.setDate(next.getDate() + 1);
            checkOutPicker.set("minDate", next);
            checkOutPicker.open();
        }
    });

    // âœ… CHECK-OUT (DISABLE + COLOR)
    checkOutPicker = flatpickr("input[name='check_out']", {
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: disabledDates,
        disableMobile: true,

        onDayCreate(_, __, ___, dayElem) {
            decorate(dayElem);
        }
    });

});
</script>

{% endblock %}
